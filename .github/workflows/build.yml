---
name: Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-blitzid:
    name: Build blitzid
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - uses: cachix/cachix-action@v15
        with:
          name: blitzi
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Build blitzid package
        run: nix build .#blitzid

      - name: Check blitzid binary
        run: |
          ls -lh result/bin/blitzid
          file result/bin/blitzid

      - name: Build blitzid-image
        run: nix build .#blitzid-image

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push blitzid-image to GHCR
        run: |
          # Load the image built by nix and extract the image name
          LOADED_IMAGE=$(docker load < result | awk '{print $NF}')
          echo "Loaded image: $LOADED_IMAGE"
          # Tag and push to GHCR
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/blitzid"
          docker tag "$LOADED_IMAGE" "$IMAGE_NAME:${{ github.sha }}"
          docker push "$IMAGE_NAME:${{ github.sha }}"
          # Also tag as latest on master branch
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            docker tag "$LOADED_IMAGE" "$IMAGE_NAME:latest"
            docker push "$IMAGE_NAME:latest"
          fi
